@model CartViewModel
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Shopping Cart</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .cart-container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .cart-item {
            border-bottom: 1px solid #e9ecef;
            padding: 20px 0;
        }

            .cart-item:last-child {
                border-bottom: none;
            }

        .product-image {
            max-width: 80px;
            height: auto;
        }

        .quantity-control {
            width: 120px;
        }

        .summary-card {
            background-color: #f1f3f5;
            border-radius: 10px;
        }

        .stock-status {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .update-feedback {
            display: none;
            font-size: 0.9rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4 text-center"><i class="fas fa-shopping-cart mr-2"></i>Your Shopping Cart</h1>

        @if (Model.CartItems.Count == 0)
        {
            <div class="alert alert-info text-center" role="alert">
                <i class="fas fa-info-circle mr-2"></i>Your cart is empty.
            </div>
        }
        else
        {
            <div class="cart-container p-4">
                @for (int i = 0; i < Model.CartItems.Count; i++)
                {
                    var item = Model.CartItems[i];
                    var total = item.Quantity * item.Price;
                    <div class="cart-item row align-items-center">
                        <div class="col-md-1 text-center">
                            <span class="badge badge-secondary">@(i + 1)</span>
                        </div>
                        <div class="col-md-2">
                            <img src="/api/placeholder/80/80" alt="@item.ProductName" class="product-image">
                        </div>
                        <div class="col-md-3">
                            <h5>@item.ProductName</h5>
                            <p class="text-muted">@item.Price.ToString("C")</p>
                            <p class="stock-status">In stock: <span class="stock-quantity">@item.StockQuantity</span></p>
                        </div>
                        <div class="col-md-2">
                            <form class="update-quantity-form" data-product-id="@item.ProductID">
                                <input type="hidden" name="productId" value="@item.ProductID">
                                <div class="input-group quantity-control">
                                    <div class="input-group-prepend">
                                        <button type="button" class="btn btn-outline-secondary" onclick="decrementQuantity(this)"><i class="fas fa-minus"></i></button>
                                    </div>

                                    <input type="number" name="quantity" class="form-control text-center" value="@item.Quantity" min="1" max="@item.StockQuantity" readonly style="width: 50px; font-size: 1 rem;">

                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-secondary" onclick="incrementQuantity(this)"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                                <div class="update-feedback text-success">
                                    <i class="fas fa-check-circle mr-1"></i>Updated successfully
                                </div>
                            </form>
                        </div>
                        <div class="col-md-2 text-right">
                            <h5 class="item-total">@total.ToString("C")</h5>
                        </div>
                        <div class="col-md-2 text-right">
                            <form asp-controller="Cart" asp-action="Delete" method="post">
                                <input type="hidden" name="productId" value="@item.ProductID">
                                <button type="submit" class="btn btn-outline-danger"><i class="fas fa-trash-alt"></i></button>
                            </form>
                        </div>
                    </div>
                }

                <div class="row mt-4">
                    <div class="col-md-6 offset-md-6">
                        <div class="summary-card p-3">
                            <h4 class="mb-3">Order Summary</h4>
                            <div class="d-flex justify-content-between">
                                <span>Total Items:</span>
                                <strong id="total-items">@Model.CartItems.Sum(item => item.Quantity)</strong>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <span>Total Amount:</span>
                                <strong id="total-amount">@Model.TotalAmount.ToString("C")</strong>
                            </div>
                            <form asp-controller="Order" asp-action="CreateOrder" method="post" class="mt-3">
                                <button type="submit" class="btn btn-success btn-block"><i class="fas fa-check mr-2"></i>Place Order</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <script>
        function incrementQuantity(button) {
            var input = button.closest('.input-group').querySelector('input[name="quantity"]');
            var max = parseInt(input.max);
            var value = parseInt(input.value);

            if (value < max) {
                input.value = value + 1;
                updateCart(button.closest('form'));
            }
            toggleButtonState(button.closest('.input-group'));
        }

        function decrementQuantity(button) {
            var input = button.closest('.input-group').querySelector('input[name="quantity"]');
            var min = parseInt(input.min);
            var value = parseInt(input.value);

            if (value > min) {
                input.value = value - 1;
                updateCart(button.closest('form'));
            }
            toggleButtonState(button.closest('.input-group'));
        }

        function toggleButtonState(container) {
            var input = container.querySelector('input[name="quantity"]');
            var decrementBtn = container.querySelector('button:first-child');
            var incrementBtn = container.querySelector('button:last-child');

            var min = parseInt(input.min);
            var max = parseInt(input.max);
            var value = parseInt(input.value);

            decrementBtn.disabled = value <= min;
            incrementBtn.disabled = value >= max;
        }

        function updateCart(form) {
            var productId = form.dataset.productId;
            var quantity = form.querySelector('input[name="quantity"]').value;

            // AJAX call to update cart
            $.ajax({
                url: '@Url.Action("UpdateQuantity", "Cart")',
                type: 'POST',
                data: { productId: productId, quantity: quantity },
                success: function (response) {
                    
                        updateItemTotal(form, response.itemTotal);
                        updateOrderSummary(response.totalItems, response.totalAmount);
                        showUpdateFeedback(form);
                    
                },
                error: function () {
                    alert('An error occurred. Please try again.');
                }
            });
        }

        function updateItemTotal(form, newTotal) {
            var itemTotalElement = form.closest('.cart-item').querySelector('.item-total');
            itemTotalElement.textContent = newTotal;
        }

        function updateOrderSummary(totalItems, totalAmount) {
            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('total-amount').textContent = totalAmount;
        }

        function showUpdateFeedback(form) {
            var feedback = form.querySelector('.update-feedback');
            feedback.style.display = 'block';
            setTimeout(function () {
                feedback.style.display = 'none';
            }, 2000);
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll('.quantity-control').forEach(function (container) {
                toggleButtonState(container);
            });
        });
    </script>
</body>
</html>